---
import Layout from '../layouts/Layout.astro';
import CategoryFilter from '../components/CategoryFilter.astro';

// Access runtime environment for Cloudflare SSR
const runtime = Astro.locals.runtime;
const R2_URL = runtime?.env?.R2_PUBLIC_URL || import.meta.env.R2_PUBLIC_URL || 'https://data.polynews.media';

const response = await fetch(`${R2_URL}/markets.json`);
const marketsData: { markets: any[]; lastUpdated: string } = await response.json();

const { markets, lastUpdated } = marketsData;

// Pre-compute categories
const categories = [...new Set(markets.map((m: any) => m.category || 'Uncategorized'))];
const categoryCounts = categories.reduce((acc: Record<string, number>, cat: string) => {
  acc[cat] = markets.filter((m: any) => (m.category || 'Uncategorized') === cat).length;
  return acc;
}, {} as Record<string, number>);

// Helper to safely get price change
function getChange(m: any, period: 'hour1' | 'hours24'): number {
  return m.priceChanges?.[period] ?? 0;
}

// Trending: significant absolute change OR significant relative change
// Considers both 1h and 24h movements
function isTrending(m: any): boolean {
  const change1h = getChange(m, 'hour1');
  const change24h = getChange(m, 'hours24');
  const currentProb = m.displayProbability ?? 50;

  // Absolute threshold: 3+ percentage points
  if (Math.abs(change1h) >= 3 || Math.abs(change24h) >= 3) return true;

  // Relative threshold for low-probability markets
  // A move from 5% to 8% is only 3 absolute points but 60% relative increase
  const prev24h = currentProb - change24h;
  if (prev24h > 0 && prev24h < 25) {
    const relativeChange = Math.abs(change24h) / prev24h;
    if (relativeChange >= 0.5) return true; // 50%+ relative move
  }

  return false;
}

// Score for sorting trending markets (higher = more trending)
function trendingScore(m: any): number {
  const change1h = getChange(m, 'hour1');
  const change24h = getChange(m, 'hours24');
  // Weight 1h changes more heavily (more recent momentum)
  return Math.abs(change1h) * 3 + Math.abs(change24h);
}

// Sort: trending first by score, then non-trending by volume
const trendingMarkets = markets
  .filter((m: any) => isTrending(m))
  .sort((a: any, b: any) => trendingScore(b) - trendingScore(a));

const nonTrendingMarkets = markets
  .filter((m: any) => !isTrending(m))
  .sort((a: any, b: any) => Number(b.volume ?? 0) - Number(a.volume ?? 0));

const sortedMarkets = [...trendingMarkets, ...nonTrendingMarkets];

function formatVolume(vol: number): string {
  if (vol >= 1_000_000) return `${(vol / 1_000_000).toFixed(1)}M`;
  if (vol >= 1_000) return `${(vol / 1_000).toFixed(0)}K`;
  return `${vol.toFixed(0)}`;
}

function getDaysRemaining(endDate: string): number {
  return Math.ceil((new Date(endDate).getTime() - Date.now()) / (1000 * 60 * 60 * 24));
}

function formatLastUpdated(timestamp: string): string {
  const mins = Math.floor((Date.now() - new Date(timestamp).getTime()) / 60000);
  if (mins < 1) return 'Updated just now';
  if (mins < 60) return `Updated ${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `Updated ${hrs}h ago`;
  return `Updated ${Math.floor(hrs / 24)}d ago`;
}

const POLYMARKET_URL = 'https://polymarket.com';
const POLYMARKET_REF = '?via=ferdous-bhai';
---

<Layout title="PolyNews - Prediction Market Forecasts">
  <header>
    <div class="container">
      <div class="logo">
        <span class="logo-icon">ðŸ”®</span>
        <h1>PolyNews</h1>
      </div>
      <div class="header-meta">
        <span class="live-dot"></span>
        <span>Live</span>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="filters-section">
      <CategoryFilter
        categories={categories}
        counts={categoryCounts}
      />
    </div>

    <div class="market-list" id="market-list">
      {sortedMarkets.map((market: any) => {
        const trending = isTrending(market);
        const url = market.eventSlug
          ? `${POLYMARKET_URL}/event/${market.eventSlug}${POLYMARKET_REF}`
          : `${POLYMARKET_URL}/${market.slug}${POLYMARKET_REF}`;
        const days = getDaysRemaining(market.endDateIso);

        return (
          <div
            class={`market-item${trending ? ' trending' : ''}`}
            data-category={market.category || 'Uncategorized'}
          >
            <div class="vote-box">{formatVolume(Number(market.volume))}</div>
            <div class="market-content">
              <div class="market-title-row">
                <a href={url} target="_blank" rel="noopener" class="market-title">
                  {market.statement || market.question}
                </a>
                <div class="probability-group">
                  <span>{market.displayProbability}%</span>
                  <span>{days}d</span>
                </div>
              </div>
            </div>
          </div>
        );
      })}
    </div>
  </main>

  <footer>
    <div class="container">
      <span>{formatLastUpdated(lastUpdated)}</span>
      <span>Markets closing within 90 days Â· <a href={`${POLYMARKET_URL}${POLYMARKET_REF}`} target="_blank" rel="noopener">Polymarket</a></span>
    </div>
  </footer>
</Layout>
