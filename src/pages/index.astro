---
import Layout from '../layouts/Layout.astro';
import CategoryFilter from '../components/CategoryFilter.astro';

// Access runtime environment for Cloudflare SSR
const runtime = Astro.locals.runtime;
const R2_URL = runtime?.env?.R2_PUBLIC_URL || import.meta.env.R2_PUBLIC_URL || 'https://data.polynews.media';

const response = await fetch(`${R2_URL}/markets.json`);
const marketsData: { markets: any[]; lastUpdated: string } = await response.json();

const { markets, lastUpdated } = marketsData;
// Markets come pre-sorted by trending score from the worker

// Pre-compute categories
const categories = [...new Set(markets.map((m: any) => m.category || 'Uncategorized'))];
const categoryCounts = categories.reduce((acc: Record<string, number>, cat: string) => {
  acc[cat] = markets.filter((m: any) => (m.category || 'Uncategorized') === cat).length;
  return acc;
}, {} as Record<string, number>);

function formatVolume(vol: number): string {
  if (vol >= 1_000_000) return `${(vol / 1_000_000).toFixed(1)}M`;
  if (vol >= 1_000) return `${(vol / 1_000).toFixed(0)}K`;
  return `${vol.toFixed(0)}`;
}

function getDaysRemaining(endDate: string): number {
  return Math.ceil((new Date(endDate).getTime() - Date.now()) / (1000 * 60 * 60 * 24));
}

function formatLastUpdated(timestamp: string): string {
  const mins = Math.floor((Date.now() - new Date(timestamp).getTime()) / 60000);
  if (mins < 1) return 'Updated just now';
  if (mins < 60) return `Updated ${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `Updated ${hrs}h ago`;
  return `Updated ${Math.floor(hrs / 24)}d ago`;
}

// Format trending reasons for display
function formatTrendingReason(market: any): string {
  const reasons = market.trendingScore?.reasons || [];
  if (reasons.length === 0) return '';
  return reasons[0]; // Show primary reason
}

const POLYMARKET_URL = 'https://polymarket.com';
const POLYMARKET_REF = '?via=ferdous-bhai';
---

<Layout title="PolyNews - Prediction Market Forecasts">
  <header>
    <div class="container">
      <div class="logo">
        <span class="logo-icon">ðŸ”®</span>
        <h1>PolyNews</h1>
      </div>
      <div class="header-meta">
        <span class="live-dot"></span>
        <span>Live</span>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="filters-section">
      <CategoryFilter
        categories={categories}
        counts={categoryCounts}
      />
    </div>

    <div class="market-list" id="market-list">
      {markets.map((market: any, index: number) => {
        const url = market.eventSlug
          ? `${POLYMARKET_URL}/event/${market.eventSlug}${POLYMARKET_REF}`
          : `${POLYMARKET_URL}/${market.slug}${POLYMARKET_REF}`;
        const days = getDaysRemaining(market.endDateIso);
        const trendingReason = formatTrendingReason(market);
        const score = market.trendingScore?.score || 0;
        // Top 3 get extra highlight
        const isHot = index < 3 && score >= 25;

        return (
          <div
            class={`market-item trending${isHot ? ' hot' : ''}`}
            data-category={market.category || 'Uncategorized'}
          >
            <div class="score-box" title={`Trending score: ${score}`}>{score}</div>
            <div class="market-content">
              <div class="market-title-row">
                <a href={url} target="_blank" rel="noopener" class="market-title">
                  {market.statement || market.question}
                </a>
                <div class="probability-group">
                  <span>{market.displayProbability}%</span>
                  <span>{days}d</span>
                </div>
              </div>
              {trendingReason && (
                <div class="trending-reason">{trendingReason}</div>
              )}
            </div>
          </div>
        );
      })}
    </div>
  </main>

  <footer>
    <div class="container">
      <span>{formatLastUpdated(lastUpdated)}</span>
      <span>Trending markets Â· <a href={`${POLYMARKET_URL}${POLYMARKET_REF}`} target="_blank" rel="noopener">Polymarket</a></span>
    </div>
  </footer>
</Layout>
